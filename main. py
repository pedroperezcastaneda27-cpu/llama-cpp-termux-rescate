
from user_manager import UserManager
from cola_de_trabajos import JobQueue
from procesador_de_video import convert_video

if __name__ == "__main__":
    # 1) Inicializar gestor de usuarios
    manager = UserManager()

    # 2) Cargar usuario (ejemplo: Pedro)
    datos = manager.inicializar_usuario("Pedro")
    usuario = datos["usuario"]
    plan_cfg = datos["plan"]

    print(f"Usuario: {usuario['nombre']} | Plan: {plan_cfg['name']} | Créditos iniciales: {manager.get_balance()}")

    # 3) Crear cola de trabajos
    cola = JobQueue()

    # 4) Simular que el usuario pide un video según su plan
    clave_video = list(plan_cfg["video_cost"].keys())[0]  # toma la primera clave del plan
    costo = plan_cfg["video_cost"][clave_video]

    if manager.consume("video_1.mp4", costo=costo):
        cola.add_job({"video": "video_1.mp4", "salida": "video_1_fijo.mp4"})
        print(f"Video agregado a la cola ({clave_video}). Créditos restantes:", manager.get_balance())
    else:
        print("No hay créditos suficientes para generar el video.")

    # 5) Procesar la cola y reconvertir para compatibilidad
    trabajo = cola.obtener_siguiente_trabajo()
    if trabajo:
        convert_video(trabajo["video"], trabajo["salida"])
        print("Video procesado y convertido:", trabajo["salida"])
        print("Historial:", manager.get_history())
import json

USUARIOS_FILE = "usuarios.json"

def cargar_usuarios():
    try:
        with open(USUARIOS_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except FileNotFoundError:
        return {}

def guardar_usuarios(data):
    with open(USUARIOS_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, indent=2, ensure_ascii=False)

def registrar_usuario(correo, nombre=""):
    usuarios = cargar_usuarios()
    if correo not in usuarios:
        usuarios[correo] = {
            "nombre": nombre,
            "plan": "Básico",
            "creditos": 5,
            "historial": []
        }
        guardar_usuarios(usuarios)
        return f"Usuario {nombre} registrado con 5 toques."
    else:
        return f"Bienvenido de nuevo {usuarios[correo]['nombre']}. Créditos disponibles: {usuarios[correo]['creditos']}"

def generar_video(correo, archivo_video):
    usuarios = cargar_usuarios()
    if correo in usuarios and usuarios[correo]["creditos"] > 0:
        usuarios[correo]["creditos"] -= 1
        usuarios[correo]["historial"].append(archivo_video)
        guardar_usuarios(usuarios)
        return f"Video generado: {archivo_video}. Créditos restantes: {usuarios[correo]['creditos']}"
    else:
        return "No tienes créditos suficientes."
